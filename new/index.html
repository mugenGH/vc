<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asylum of Echoes</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="overlay"></div>
  <div style="position: fixed; bottom: 10px; right: 10px; background: white; color: black; padding: 10px; border-radius: 4px; max-width: 300px; max-height: 200px; overflow: auto; z-index: 100000; font-size: 11px; font-family: monospace; display: block;" id="debug-console"></div>
  <main id="app">
    <header>
      <h1>ASYLUM OF ECHOES</h1>
      <div class="meta">
        <span id="room-name">Main Menu</span>
        <span id="chapter-info">Chapter 0</span>
        <span id="clue-info">Clues: 0</span>
        <span id="fear-info">Fear: 0</span>
      </div>
    </header>

    <aside id="sidebar">
      <section id="inventory" hidden>
        <h3>Inventory</h3>
        <div id="inventory-grid"></div>
      </section>
      
      <section id="character-status" hidden>
        <h3>Companions</h3>
        <div id="npc-status"></div>
      </section>
    </aside>

    <section id="main-scene">
      <div id="menu">
        <div class="menu-content">
          <div class="menu-hero">
            <h2>Asylum of Echoes</h2>
            <p class="tagline">The building remembers. Will you listen?</p>
          </div>

          <div class="menu-actions">
            <button id="new-game" class="primary-btn">Start New Game</button>
            <div class="row">
              <button id="continue-game" class="secondary-btn">Continue</button>
              <button id="toggle-audio" class="secondary-btn">Audio: On</button>
            </div>
          </div>

          <div id="save-slots"></div>

          <div class="menu-footer">
            <small>Built with whispers and static â€” a horror text experience.</small>
          </div>
        </div>
      </div>

      <div id="scene" hidden>
        <div id="background"><img id="background-img" alt="room background" /></div>
        <div id="scene-text"></div>
        <div id="presence"></div>
      </div>
    </section>

    <section id="dialogue" hidden>
      <h3 id="dialogue-name"></h3>
      <p id="dialogue-text"></p>
    </section>

    <section id="choices" hidden></section>
    
    <div id="puzzle-modal" hidden>
      <div class="puzzle-container">
        <div class="puzzle-title" id="puzzle-title"></div>
        <div class="puzzle-content" id="puzzle-content"></div>
        <div class="puzzle-hints" id="puzzle-hints"></div>
        <div class="puzzle-controls" id="puzzle-controls"></div>
      </div>
    </div>
  </main>

  <script>
    const debugDiv = document.getElementById('debug-console');
    function log(msg) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(msg);
      debugDiv.innerHTML += `[${timestamp}] ${msg}<br>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
    log('Page loading...');
    
    window.addEventListener("error", function(event) {
      log('ERROR: ' + event.message);
      console.error("Global Error:", event.error);
      const errorBox = document.createElement("div");
      errorBox.style.cssText = "position:fixed; top:0; left:0; right:0; padding:20px; background:#800; color:#fff; z-index:9999; font-family:monospace;";
      errorBox.innerHTML = "<strong>Runtime Error:</strong> " + event.message + "<br><small>" + event.filename + ":" + event.lineno + "</small>";
      document.body.appendChild(errorBox);
    });
  </script>

  <script type="module">
    const debugDiv = document.getElementById('debug-console');
    function log(msg) {
      const timestamp = new Date().toLocaleTimeString();
      debugDiv.innerHTML += `[${timestamp}] ${msg}<br>`;
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
    
    log('Module loading started...');
    import { gameState } from './js/gameState.js';
    import { NPCs, PUZZLES, ROOMS, ENDINGS, itemDescriptions } from './js/config.js';
    import { soundManager } from './js/soundManager.js';
    import { ui, showMainMenu, showGame, renderSaveSlots, hideAllScreens } from './js/ui.js';
    log('All modules imported successfully');
    import { 
      switchRoom, 
      handleChoice, 
      attemptPuzzle, 
      createPuzzleInterface,
      startNewGame,
      getDwarfDialogue,
      getTrollDialogue
    } from './js/gameEngine.js';

    // Make game data globally available
    window.ROOMS = ROOMS;
    window.NPCs = NPCs;
    window.PUZZLES = PUZZLES;
    window.ENDINGS = ENDINGS;
    window.gameState = gameState;

    // Global functions for puzzle UI
    window.triggerChoice = (action) => handleChoice(action);
    window.switchRoom = switchRoom;
    window.attemptPuzzle = attemptPuzzle;

    window.revealHintUI = function(index, puzzleId) {
      const puzzle = window.PUZZLES[puzzleId];
      const hintBtn = document.getElementById(`hint-${index}`);
      hintBtn.textContent = puzzle.hints[index];
      hintBtn.disabled = true;
      hintBtn.style.background = 'rgba(0,243,255,0.4)';
    };

    window.solvePuzzleUI = function(puzzleId) {
      const puzzle = window.PUZZLES[puzzleId];
      const answer = document.getElementById('puzzle-answer').value.trim().toUpperCase();
      const result = window.attemptPuzzle(puzzleId, answer);
      
      const resultDiv = document.createElement('div');
      resultDiv.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(139,0,0,0.9), rgba(0,0,0,0.9));
        border: 3px solid var(--gold); border-radius: 16px; padding: 24px;
        color: var(--parchment); text-align: center; font-size: 1.2rem;
        z-index: 10000; max-width: 80%; animation: resultFade 4s ease forwards;
      `;
      resultDiv.textContent = result;
      document.body.appendChild(resultDiv);
      
      setTimeout(() => {
        window.closePuzzleUI();
        document.body.removeChild(resultDiv);
        
        if (gameState.flags.cell_puzzle_solved && puzzleId === 'cell_puzzle') {
          gameState.currentRoom = "cell";
          gameState.flags.white_skeleton_seen = true;
        }
        if (gameState.flags.cabinet_code_solved && puzzleId === 'cabinet_code') {
          gameState.currentRoom = "cell";
        }
        
        window.switchRoom(gameState.currentRoom);
      }, 3000);
    };

    window.closePuzzleUI = function() {
      if (ui.puzzleModal) {
        ui.puzzleModal.hidden = true;
        document.getElementById('puzzle-content').innerHTML = '';
        document.getElementById('puzzle-hints').innerHTML = '';
        document.getElementById('puzzle-controls').innerHTML = '';
      }
    };

    // Initialize the game
    function init() {
      try {
        log('Init started');
        log('UI elements check:');
        log('newGame: ' + (ui.newGame ? 'OK' : 'MISSING'));
        log('continueGame: ' + (ui.continueGame ? 'OK' : 'MISSING'));
        log('toggleAudio: ' + (ui.toggleAudio ? 'OK' : 'MISSING'));
        
        if (!ui.newGame || !ui.continueGame || !ui.toggleAudio) {
          log('ERROR: Required UI elements not found');
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;max-width:600px;background:red;color:white;padding:20px;border-radius:8px;z-index:10000;font-family:monospace;';
          errorDiv.innerHTML = '<strong>ERROR: UI elements missing!</strong><br>' + 
            'newGame: ' + (ui.newGame ? 'OK' : 'MISSING') + '<br>' +
            'continueGame: ' + (ui.continueGame ? 'OK' : 'MISSING') + '<br>' +
            'toggleAudio: ' + (ui.toggleAudio ? 'OK' : 'MISSING');
          document.body.appendChild(errorDiv);
          return;
        }
        
        log('Attaching event listeners');
        ui.newGame.addEventListener("click", () => {
          log('New Game clicked');
          startNewGame();
        });

        ui.continueGame.addEventListener("click", () => {
          try {
            log('Continue clicked');
            if (gameState.load("autosave")) {
              log('Loaded autosave');
              showGame();
            } else {
              log('No autosave, starting new game');
              startNewGame();
            }
          } catch (e) {
            log('Error in continue: ' + e.message);
            startNewGame();
          }
        });

        ui.toggleAudio.addEventListener("click", () => {
          gameState.audioOn = !gameState.audioOn;
          ui.toggleAudio.textContent = "Audio: " + (gameState.audioOn ? "On" : "Off");
        });

        log('Checking for autosave');
        const hasSave = gameState.hasSave("autosave");
        ui.continueGame.disabled = !hasSave;

        setInterval(() => gameState.save("autosave"), 30000);
        window.addEventListener("beforeunload", () => gameState.save("autosave"));

        log('Showing main menu');
        showMainMenu();
        log('Init complete!');
      } catch (err) {
        log('INIT ERROR: ' + err.message);
        console.error("Init error", err);
      }
    }

    try {
      log('Initializing game...');
      init();
    } catch (err) {
      log('Init outer error: ' + err.message);
      console.error("Init error", err);
      const errorBox = document.createElement("div");
      errorBox.style.cssText = "position:fixed; top:0; left:0; right:0; padding:20px; background:#800; color:#fff; z-index:9999; font-family:monospace;";
      errorBox.innerHTML = "<strong>Init Error:</strong> " + err.message + "<br>" + err.stack;
      document.body.appendChild(errorBox);
    }
  </script>
</body>
</html>
